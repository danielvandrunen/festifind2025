#!/usr/bin/env node

/**
 * Persistence Testing Tool
 * 
 * This script creates browser console code to test persistence step-by-step
 */

console.log('=== FestiFind Persistence Testing Tool ===\n');

console.log('ðŸ“‹ Copy and paste this code in your browser console on:');
console.log('   https://festifind2025.vercel.app/festivals\n');

console.log('// === COPY THIS PERSISTENCE TEST CODE ===');
console.log('');
console.log('console.log("ðŸ§ª === FestiFind Persistence Testing ===\\n");');
console.log('');
console.log('// Test persistence step by step');
console.log('let testFestivalId = null;');
console.log('let testFestivalName = null;');
console.log('');
console.log('// Step 1: Find a test festival');
console.log('console.log("ðŸ“ Step 1: Finding a test festival...");');
console.log('const festivalCards = document.querySelectorAll("[data-festival-id]");');
console.log('if (festivalCards.length === 0) {');
console.log('  console.log("âŒ No festivals found on page. Make sure you are on the festivals page.");');
console.log('} else {');
console.log('  testFestivalId = festivalCards[0].getAttribute("data-festival-id");');
console.log('  testFestivalName = festivalCards[0].querySelector("h3, .font-medium")?.textContent || "Unknown Festival";');
console.log('  console.log(`âœ… Using test festival: ${testFestivalName} (ID: ${testFestivalId})`);');
console.log('}');
console.log('');
console.log('// Step 2: Check current state from database');
console.log('console.log("\\nðŸ“ Step 2: Checking current state...");');
console.log('if (testFestivalId) {');
console.log('  fetch(`/api/festivals?search=${encodeURIComponent(testFestivalName)}`)');
console.log('    .then(r => r.json())');
console.log('    .then(festivals => {');
console.log('      const festival = festivals.find(f => f.id === testFestivalId);');
console.log('      if (festival) {');
console.log('        console.log("âœ… Current state:", {');
console.log('          name: festival.name,');
console.log('          favorite: festival.favorite,');
console.log('          archived: festival.archived,');
console.log('          sales_stage: festival.sales_stage');
console.log('        });');
console.log('        window.testFestival = festival;');
console.log('      } else {');
console.log('        console.log("âŒ Festival not found in API response");');
console.log('      }');
console.log('    })');
console.log('    .catch(err => console.log("âŒ Error fetching festival:", err));');
console.log('}');
console.log('');
console.log('// Test functions - run these manually:');
console.log('');
console.log('// 3a. Test Favorite Toggle:');
console.log('window.testFavorite = async () => {');
console.log('  if (!testFestivalId) return console.log("âŒ No test festival ID");');
console.log('  console.log("ðŸ”„ Setting festival as favorite...");');
console.log('  const response = await fetch(`/api/festivals/${testFestivalId}/favorite`, {');
console.log('    method: "POST",');
console.log('    headers: { "Content-Type": "application/json" },');
console.log('    body: JSON.stringify({ favorite: true })');
console.log('  });');
console.log('  const result = await response.json();');
console.log('  console.log("ðŸ“¤ API Response:", result);');
console.log('  setTimeout(async () => {');
console.log('    console.log("ðŸ” Checking if saved to database...");');
console.log('    const checkResponse = await fetch(`/api/festivals?search=${encodeURIComponent(testFestivalName)}`);');
console.log('    const festivals = await checkResponse.json();');
console.log('    const updated = festivals.find(f => f.id === testFestivalId);');
console.log('    console.log("ðŸ“¥ Database state:", { favorite: updated?.favorite });');
console.log('  }, 1000);');
console.log('};');
console.log('');
console.log('// 3b. Test Archive Toggle:');
console.log('window.testArchive = async () => {');
console.log('  if (!testFestivalId) return console.log("âŒ No test festival ID");');
console.log('  console.log("ðŸ”„ Setting festival as archived...");');
console.log('  const response = await fetch(`/api/festivals/${testFestivalId}/archive`, {');
console.log('    method: "POST",');
console.log('    headers: { "Content-Type": "application/json" },');
console.log('    body: JSON.stringify({ archived: true })');
console.log('  });');
console.log('  const result = await response.json();');
console.log('  console.log("ðŸ“¤ API Response:", result);');
console.log('  setTimeout(async () => {');
console.log('    console.log("ðŸ” Checking if saved to database...");');
console.log('    const checkResponse = await fetch(`/api/festivals?search=${encodeURIComponent(testFestivalName)}`);');
console.log('    const festivals = await checkResponse.json();');
console.log('    const updated = festivals.find(f => f.id === testFestivalId);');
console.log('    console.log("ðŸ“¥ Database state:", { archived: updated?.archived });');
console.log('  }, 1000);');
console.log('};');
console.log('');
console.log('// 3c. Check localStorage:');
console.log('window.checkLocalStorage = () => {');
console.log('  console.log("ðŸ” Current localStorage state:");');
console.log('  const keys = ["festifind-favorites", "festifind-archived"];');
console.log('  keys.forEach(key => {');
console.log('    const value = localStorage.getItem(key);');
console.log('    if (value) {');
console.log('      const parsed = JSON.parse(value);');
console.log('      console.log(`  ${key}:`, parsed);');
console.log('    } else {');
console.log('      console.log(`  ${key}: empty`);');
console.log('    }');
console.log('  });');
console.log('};');
console.log('');
console.log('// 3d. Test refresh behavior:');
console.log('window.testRefreshBehavior = async () => {');
console.log('  console.log("ðŸ”„ Testing refresh behavior...");');
console.log('  const response = await fetch("/api/festivals");');
console.log('  const festivals = await response.json();');
console.log('  const testFestival = festivals.find(f => f.id === testFestivalId);');
console.log('  console.log("ðŸ“¥ Fresh data from API:", {');
console.log('    name: testFestival?.name,');
console.log('    favorite: testFestival?.favorite,');
console.log('    archived: testFestival?.archived,');
console.log('    sales_stage: testFestival?.sales_stage');
console.log('  });');
console.log('};');
console.log('');
console.log('// === END COPY ===');

console.log('\nðŸ’¡ How to use after pasting:');
console.log('  1. Run: testFavorite()         - Test favorite toggle');
console.log('  2. Run: testArchive()          - Test archive toggle'); 
console.log('  3. Run: checkLocalStorage()    - Check localStorage');
console.log('  4. Run: testRefreshBehavior()  - Simulate refresh');
console.log('  5. Actually refresh page (F5) to see if changes persist');

console.log('\nðŸŽ¯ This will help us identify:');
console.log('  - Whether API calls succeed');
console.log('  - Whether changes save to database');
console.log('  - Whether changes save to localStorage'); 
console.log('  - Whether refresh loads the correct data');
console.log('  - Where exactly the persistence breaks down'); 